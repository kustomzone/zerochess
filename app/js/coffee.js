(function(){var ZeroFrame,bind=function(fn,me){return function(){return fn.apply(me,arguments);};},slice=[].slice;ZeroFrame=(function(){function ZeroFrame(url){this.onCloseWebsocket=bind(this.onCloseWebsocket,this);this.onOpenWebsocket=bind(this.onOpenWebsocket,this);this.route=bind(this.route,this);this.onMessage=bind(this.onMessage,this);this.url=url;this.waiting_cb={};this.wrapper_nonce=document.location.href.replace(/.*wrapper_nonce=([A-Za-z0-9]+).*/,"$1");this.connect();this.next_message_id=1;this.init();}ZeroFrame.prototype.init=function(){return this;};ZeroFrame.prototype.connect=function(){this.target=window.parent;window.addEventListener("message",this.onMessage,false);return this.cmd("innerReady");};ZeroFrame.prototype.onMessage=function(e){var cmd,message;message=e.data;cmd=message.cmd;if(cmd==="response"){if(this.waiting_cb[message.to]!=null){return this.waiting_cb[message.to](message.result);}else{return this.log("Websocket callback not found:",message);}}else{if(cmd==="wrapperReady"){return this.cmd("innerReady");}else{if(cmd==="ping"){return this.response(message.id,"pong");}else{if(cmd==="wrapperOpenedWebsocket"){return this.onOpenWebsocket();}else{if(cmd==="wrapperClosedWebsocket"){return this.onCloseWebsocket();}else{return this.route(cmd,message);}}}}}};ZeroFrame.prototype.route=function(cmd,message){return this.log("Unknown command",message);};ZeroFrame.prototype.response=function(to,result){return this.send({"cmd":"response","to":to,"result":result});};ZeroFrame.prototype.cmd=function(cmd,params,cb){if(params==null){params={};}if(cb==null){cb=null;}return this.send({"cmd":cmd,"params":params},cb);};ZeroFrame.prototype.send=function(message,cb){if(cb==null){cb=null;}message.wrapper_nonce=this.wrapper_nonce;message.id=this.next_message_id;this.next_message_id+=1;this.target.postMessage(message,"*");if(cb){return this.waiting_cb[message.id]=cb;}};ZeroFrame.prototype.log=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return console.log.apply(console,["[ZeroFrame]"].concat(slice.call(args)));};ZeroFrame.prototype.onOpenWebsocket=function(){return this.log("Websocket open");};ZeroFrame.prototype.onCloseWebsocket=function(){return this.log("Websocket close");};return ZeroFrame;})();window.ZeroFrame=ZeroFrame;}).call(this);(function(){var Text;Text=(function(){function Text(){}Text.prototype.toColor=function(text,saturation,lightness){var hash,i,j,ref;if(saturation==null){saturation=30;}if(lightness==null){lightness=40;}hash=0;for(i=j=0,ref=text.length-1;0<=ref?j<=ref:j>=ref;i=0<=ref?++j:--j){hash+=text.charCodeAt(i)*i;hash=hash%1777;}return"hsl("+(hash%360)+(","+saturation+"%,"+lightness+"%)");};return Text;})();window.Text=new Text();}).call(this);(function(){var Time;Time=(function(){function Time(){}Time.prototype.since=function(time){var back,now,secs;now=+(new Date)/1000;secs=now-time;if(secs<60){back="Just now";}else{if(secs<60*60){back=(Math.round(secs/60))+" minutes ago";}else{if(secs<60*60*24){back=(Math.round(secs/60/60))+" hours ago";}else{if(secs<60*60*24*3){back=(Math.round(secs/60/60/24))+" days ago";}else{back="on "+this.date(time);}}}}back=back.replace(/1 ([a-z]+)s/,"1 $1");return back;};Time.prototype.date=function(timestamp,format){var display,parts;if(format==null){format="short";}parts=(new Date(timestamp*1000)).toString().split(" ");if(format==="short"){display=parts.slice(1,4);}else{display=parts.slice(1,5);}return display.join(" ").replace(/( [0-9]{4})/,",$1");};Time.prototype.timestamp=function(date){if(date==null){date="";}if(date==="now"||date===""){return parseInt(+(new Date)/1000);}else{return parseInt(Date.parse(date)/1000);}};return Time;})();window.Time=new Time;}).call(this);(function(){var ZeroList,bind=function(fn,me){return function(){return fn.apply(me,arguments);};},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key)){child[key]=parent[key];}}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;ZeroList=(function(superClass){var prepareSite;extend(ZeroList,superClass);function ZeroList(){this.writeFile=bind(this.writeFile,this);this.loadFile=bind(this.loadFile,this);this.displayMessage=bind(this.displayMessage,this);this.onOpenWebsocket=bind(this.onOpenWebsocket,this);this.sendMessage=bind(this.sendMessage,this);this.selectUser=bind(this.selectUser,this);return ZeroList.__super__.constructor.apply(this,arguments);}ZeroList.prototype.init=function(){this.addLine("inited!");this.vm=prepareSite();this.vm.selectUserCallback=this.selectUser;this.vm.writeFileCallback=this.writeFile;this.vm.messageCallback=this.displayMessage;return this.vm.startWatch();};ZeroList.prototype.addLine=function(line){var messages;messages=document.getElementById("messages");return messages.innerHTML=("<li>"+line+"</li>")+messages.innerHTML;};ZeroList.prototype.selectUser=function(){Page.cmd("certSelect",[["zeroid.bit"]]);return false;};ZeroList.prototype.loadMessages=function(){var query;query="SELECT message.*, keyvalue.value AS cert_user_id FROM message\nLEFT JOIN json AS data_json USING (json_id)\nLEFT JOIN json AS content_json ON (\n    data_json.directory = content_json.directory AND content_json.file_name = 'content.json'\n)\nLEFT JOIN keyvalue ON (keyvalue.key = 'cert_user_id' AND keyvalue.json_id = content_json.json_id)\nWHERE datetime(604800+(date_added/1000),'unixepoch')>date()\nORDER BY date_added LIMIT 200";return this.cmd("dbQuery",[query],(function(_this){return function(messages){var added,body,i,len,message,message_lines;document.getElementById("messages").innerHTML="";message_lines=[];for(i=0,len=messages.length;i<len;i++){message=messages[i];body=message.body.replace(/</g,"&lt;").replace(/>/g,"&gt;");added=new Date(message.date_added);message_lines.push("<li><small title='"+added+"'>"+(Time.since(message.date_added/1000))+"</small> <b style='color: "+(Text.toColor(message.cert_user_id))+"'>"+(message.cert_user_id.replace("@zeroid.bit",""))+"</b>: "+body+"</li>");}message_lines.reverse();return document.getElementById("messages").innerHTML=message_lines.join("\n");};})(this));};ZeroList.prototype.sendMessage=function(){var inner_path;if(!Page.site_info.cert_user_id){Page.cmd("wrapperNotification",["info","Please, select your account."]);return false;}inner_path="data/users/"+this.site_info.auth_address+"/data.json";this.cmd("fileGet",{"inner_path":inner_path,"required":false},(function(_this){return function(data){var json_raw;if(data){data=JSON.parse(data);}else{data={"message":[]};}data.message.push({"body":document.getElementById("message").value,"date_added":+(new Date)});json_raw=unescape(encodeURIComponent(JSON.stringify(data,void 0,"\t")));return _this.cmd("fileWrite",[inner_path,btoa(json_raw)],function(res){_this.loadMessages();if(res==="ok"){return _this.cmd("sitePublish",{"inner_path":inner_path},function(res){return document.getElementById("message").value="";});}else{return _this.cmd("wrapperNotification",["error","File write error: "+res]);}});};})(this));return false;};ZeroList.prototype.route=function(cmd,message){var inner_path;if(cmd==="setSiteInfo"){if(message.params.cert_user_id){this.vm.cert_user_id=message.params.cert_user_id;}else{this.vm.cert_user_id=null;}this.site_info=message.params;this.log("Routed",cmd,message);if((message.params!=null)&&(message.params.event!=null)&&message.params.event.length>0&&this.vm.cert_user_id){switch(message.params.event[0]){case"cert_changed":this.loadFile();return this.updateDataSize();case"file_done":this.loadMessages();if(!this.vm.needsSaving){inner_path="data/users/"+this.site_info.auth_address+"/list.json";if(message.params.event[1]===inner_path){this.loadFile();return this.updateDataSize();}}break;default:return this.log("Unhandled event",message.params.event[0]);}}}};ZeroList.prototype.onOpenWebsocket=function(e){this.cmd("siteInfo",{},(function(_this){return function(siteInfo){var skipLoading;skipLoading=false;if(siteInfo.cert_user_id){if(_this.vm.cert_user_id===siteInfo.cert_user_id){skipLoading=true;}_this.vm.cert_user_id=siteInfo.cert_user_id;}_this.site_info=siteInfo;_this.log("Web Socket Opened",_this.vm.cert_user_id,siteInfo.cert_user_id);if(!skipLoading){_this.loadFile();}return _this.updateDataSize();};})(this));return this.loadMessages();};ZeroList.prototype.updateDataSize=function(){if(this.site_info.cert_user_id){return this.cmd("fileRules","data/users/"+this.site_info.auth_address+"/content.json",(function(_this){return function(rules){_this.log("Updating dataUsage");if(rules.current_size!=null){_this.vm.dataSize=rules.current_size;}if(rules.max_size!=null){return _this.vm.dataSizeMax=rules.max_size;}};})(this));}};ZeroList.prototype.displayMessage=function(msgtype,text){return this.cmd("wrapperNotification",[msgtype,text]);};ZeroList.prototype.loadFile=function(){var inner_path;inner_path="data/users/"+this.site_info.auth_address+"/list.json";return this.cmd("fileGet",{"inner_path":inner_path,"required":false},(function(_this){return function(data){if(data){return _this.cmd("eciesDecrypt",data,function(result){result=JSON.parse(result);_this.vm.needsSaving=false;_this.vm.loading=true;_this.vm.todos=result.todos;_this.vm.next_todo_id=result.next_todo_id;_this.vm.readNote=result.readNote;return Vue.nextTick(function(){return _this.vm.loading=false;});});}};})(this));};ZeroList.prototype.writeFile=function(json_raw,cb){var inner_path;if(cb==null){cb=false;}inner_path="data/users/"+this.site_info.auth_address+"/list.json";return this.cmd("eciesEncrypt",json_raw,(function(_this){return function(data){return _this.cmd("fileWrite",[inner_path,btoa(data)],function(res){if(res==="ok"){_this.log("File saved");if(cb){cb(true);}return _this.cmd("sitePublish",{"inner_path":inner_path},function(res){_this.log("Saved user list.json published");return _this.updateDataSize();});}else{_this.cmd("wrapperNotification",["error","File write error: "+res]);if(cb){return cb(false);}}});};})(this));};prepareSite=function(){var vm;return vm=new Vue({el:"#app",data:{next_todo_id:2,selected_todo:0,newTask:"",editingTask:null,editedTask:"",editingTodo:null,editedTodo:"",dragging:null,dragover:null,dragType:null,footer:true,readNote:false,cert_user_id:null,loading:false,saving:false,shared:false,needsSaving:false,dataSize:null,dataSizeMax:null,selectUserCallback:null,writeFileCallback:null,messageCallback:null,todos:[{todo_id:1,title:"Default",tasks:[{text:"Select a todo list on the left",checked:true},{text:"Check a task to mark it as done",checked:false},{text:"Enter a new task",checked:false},{text:"Double click a task to edit it",checked:false},{text:"Hit ESC to cancel editing",checked:false},{text:"Click the X on a task to remove it",checked:false},{text:"Drag a task or todo list to a different position",checked:false}]}]},computed:{dataUsage:function(){if(this.dataSize===null||this.dataSizeMax===null){return null;}return((this.dataSize/1024).toFixed(1))+"kb / "+((this.dataSizeMax/1024).toFixed(1))+"kb";}},methods:{todoClasses:function(index){var classList;classList=[];if(this.dragType==="todo"){if(index===this.dragging){classList.push("dragging");}if(index===this.dragover){classList.push("dragover");}}if(index===this.selected_todo){classList.push("selected");}return classList;},taskClasses:function(index){if(this.dragType==="task"){if(index===this.dragging){return["dragging"];}if(index===this.dragover){return["dragover"];}}else{return[];}},dragStart:function(event,index,item){this.dragging=index;if(item.todo_id!=null){this.dragType="todo";}else{this.dragType="task";}event.dataTransfer.effectAllowed="move";return event.dataTransfer.setData("text","dummy");},endDrag:function(){this.dragging=null;this.dragover=null;return this.dragType=null;},dropped:function(item,index){var itemSrc,itemTarget;if(item.todo_id!=null){itemSrc=this.todos[this.dragging];itemTarget=this.todos[index];this.todos.$set(this.dragging,itemTarget);return this.todos.$set(index,itemSrc);}else{itemSrc=this.todos[this.selected_todo].tasks[this.dragging];itemTarget=this.todos[this.selected_todo].tasks[index];this.todos[this.selected_todo].tasks.$set(this.dragging,itemTarget);return this.todos[this.selected_todo].tasks.$set(index,itemSrc);}},startWatch:function(){return this.$watch("todos",this.todosChanged,{deep:true});},selectUser:function(){if(!this.selectUserCallback){return;}return this.selectUserCallback();},todosChanged:function(todos){if(!this.loading){return this.needsSaving=true;}},todoClicked:function(index){document.querySelector("#right").scrollTop=0;return this.selected_todo=index;},addNewTodo:function(){var todo;todo={todo_id:this.next_todo_id,title:"New Todo list",tasks:[]};this.next_todo_id+=1;return this.todos.push(todo);},addTask:function(){if(this.newTask===""){return;}this.todos[this.selected_todo].tasks.unshift({text:this.newTask,checked:false});return this.newTask="";},deleteTask:function(task){return this.todos[this.selected_todo].tasks.$remove(task);},taskCount:function(todo){return todo.tasks.filter(function(task){return !task.checked;}).length;},editTask:function(task,index){this.editedTask=task.text;return this.editingTask=index;},editTaskDone:function(task){task.text=this.editedTask;return this.editingTask=null;},cancelEditingTask:function(task){return this.editingTask=null;},editTodo:function(todo,index){this.editedTodo=todo.title;return this.editingTodo=index;},editTodoDone:function(todo){todo.title=this.editedTodo;return this.editingTodo=null;},cancelEditingTodo:function(todo){return this.editingTodo=null;},deleteTodo:function(index){this.todos.$remove(this.todos[index]);return this.selected_todo=0;},shareList:function(index){return alert(this.todos[index].title+" is not shared! (function still pending)");},clearCompleted:function(){return this.todos[this.selected_todo].tasks=this.todos[this.selected_todo].tasks.filter(function(task){return !task.checked;});},saveUserData:function(){var data,json_raw;if(this.saving){if(this.messageCallback){this.messageCallback("info","Already saving");}return;}if(!this.writeFileCallback){return;}data={todos:this.todos,next_todo_id:this.next_todo_id,readNote:this.readNote};json_raw=unescape(encodeURIComponent(JSON.stringify(data)));this.saving=true;return this.writeFileCallback(json_raw,(function(_this){return function(result){_this.saving=false;return _this.needsSaving=false;};})(this));}},directives:{"task-focus":function(value){var el;if(!value){return;}el=this.el;return Vue.nextTick(function(){var length;el.focus();length=el.value.length;if(el.setSelectionRange!=null){return el.setSelectionRange(0,length);}});}}});};setTimeout(function(){return Page.vm.footer=false;},1000);return ZeroList;})(ZeroFrame);window.Page=new ZeroList();}).call(this);